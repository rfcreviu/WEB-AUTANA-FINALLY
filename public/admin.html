<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDON Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { 
            background: #1a1a1a; 
            color: white;
            padding: 2rem; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            border: 1px solid #333;
        }
        .hidden { display: none !important; }
        .logo-container {
            text-align: center;
            margin-bottom: 2rem;
        }
        .logo {
            max-width: 150px;
            height: auto;
            margin-bottom: 1rem;
            filter: brightness(1.1);
        }
        h1 { text-align: center; margin-bottom: 0; color: white; font-size: 1.8rem; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #ccc; }
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #555; 
            border-radius: 8px; 
            font-size: 16px;
            transition: border-color 0.3s;
            background: #333;
            color: white;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #667eea; 
        }
        button { 
            width: 100%; 
            padding: 12px; 
            background: #667eea; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background: #5a6fd8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .credentials { 
            background: #2a2a2a; 
            padding: 1rem; 
            border-radius: 8px; 
            margin-top: 1rem; 
            font-size: 14px;
            border: 1px solid #444;
        }
        .credentials h4 { margin-bottom: 0.5rem; color: white; }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            max-width: 300px;
        }
        .alert.success { background: #28a745; }
        .alert.error { background: #dc3545; }
        .admin-panel {
            background: #1a1a1a;
            min-height: 100vh;
            padding: 2rem;
            color: white;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #444;
        }
        .header .logo-header {
            max-width: 80px;
            height: auto;
            margin-right: 1rem;
        }
        .header-left {
            display: flex;
            align-items: center;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: #2a2a2a;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
            border: 1px solid #444;
        }
        .stat-number { font-size: 2rem; font-weight: bold; color: white; }
        .stat-label { color: #ccc; margin-top: 0.5rem; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2a2a2a;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            color: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #333; }
        .status-confirmed { color: #28a745; font-weight: bold; }
        .status-cancelled { color: #dc3545; font-weight: bold; }
        .status-completed { color: #6c757d; font-weight: bold; }
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin-left: 5px;
        }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        select.status-select {
            padding: 4px 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: white;
        }
        .schedule-section {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #444;
        }
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .schedule-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .schedule-form {
            display: grid;
            gap: 1rem;
        }
        .schedule-item {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            background: #333;
            border-radius: 8px;
            border: 1px solid #555;
            margin-bottom: 0.75rem;
        }
        .schedule-day-name {
            color: #667eea;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid #555;
            padding-bottom: 0.5rem;
        }
        .schedule-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .schedule-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #ccc;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.25rem 0;
        }
        .schedule-checkbox input[type="checkbox"] {
            margin: 0;
            transform: scale(1.1);
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }
        .schedule-times {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
            gap: 0.75rem;
            align-items: center;
            padding: 0.75rem;
            background: #2a2a2a;
            border-radius: 6px;
            transition: opacity 0.3s ease;
            margin-top: 0.5rem;
        }
        .schedule-times.disabled {
            opacity: 0.5;
            background: #222;
        }
        .schedule-times label {
            color: #aaa;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .schedule-times input[type="time"] {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 8px;
            color: white;
            font-size: 14px;
            min-width: 90px;
        }
        .schedule-times input[type="time"]:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        .schedule-times input[type="time"]:disabled {
            background: #111;
            border-color: #333;
            color: #666;
        }
        .schedule-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-schedule {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .btn-add {
            background: #28a745;
            color: white;
        }
        .btn-remove {
            background: #dc3545;
            color: white;
        }
        .btn-save {
            background: #667eea;
            color: white;
            padding: 8px 16px;
        }
        .btn-schedule:hover {
            opacity: 0.8;
        }
        
        /* Estilos para gesti√≥n de mesas */
        .tables-section {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #444;
        }
        .tables-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .tables-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .tables-actions {
            display: flex;
            gap: 0.5rem;
        }
        .tables-container {
            display: grid;
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .table-item {
            background: #333;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .table-item.available {
            border-color: #28a745;
        }
        .table-item.occupied {
            border-color: #dc3545;
        }
        .table-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }
        .table-id {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .table-capacity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .table-capacity label {
            color: #ccc;
            font-size: 14px;
        }
        .table-capacity input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #444;
            color: white;
            font-size: 14px;
        }
        .table-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #ccc;
            font-size: 14px;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .status-indicator.available {
            background: #28a745;
        }
        .status-indicator.occupied {
            background: #dc3545;
        }
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-tables {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .btn-tables.btn-add {
            background: #28a745;
            color: white;
        }
        .btn-tables.btn-save {
            background: #667eea;
            color: white;
            padding: 8px 16px;
        }
        .btn-tables.btn-remove-table {
            background: #dc3545;
            color: white;
        }
        .btn-tables:hover {
            opacity: 0.8;
        }

        /* Estilos para gesti√≥n de datos de clientes */
        .data-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }
        .btn-data {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-data.btn-export {
            background: #28a745;
            color: white;
        }
        .btn-data.btn-refresh {
            background: #667eea;
            color: white;
        }
        .restaurant-stats-section {
            margin-top: 2rem;
        }

        /* Estilos para sistema de tracking de enlaces */
        .tracking-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #2a2a2a;
            border-radius: 10px;
            border: 1px solid #333;
        }
        .tracking-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .tracking-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card-small {
            background: #333;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #444;
        }
        .stat-number-small {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        .stat-label-small {
            font-size: 0.8rem;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-tracking {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        .btn-tracking.btn-create {
            background: #28a745;
            color: white;
        }
        .btn-tracking.btn-delete {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
        }
        .btn-tracking:hover {
            opacity: 0.8;
        }
        .tracking-links-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .tracking-links-table th,
        .tracking-links-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        .tracking-links-table th {
            background: #333;
            color: #667eea;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tracking-links-table td {
            color: #ccc;
        }
        .tracking-link-url {
            font-family: 'Courier New', monospace;
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #667eea;
            cursor: pointer;
            user-select: all;
        }
        .tracking-link-url:hover {
            background: #444;
        }
        .tracking-clicks {
            font-weight: bold;
            color: #28a745;
        }
        .tracking-date {
            font-size: 0.85rem;
            color: #888;
        }
        .tracking-actions {
            display: flex;
            gap: 0.5rem;
        }
        .section-title {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        .restaurant-stat-card {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #444;
        }
        .restaurant-stat-number { font-size: 1.5rem; font-weight: bold; color: white; }
        .restaurant-stat-label { color: #ccc; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="login-screen">
        <div class="container">
            <div class="logo-container">
                <img src="LOGO PNG UDON.png" alt="UDON Logo" class="logo">
                <h1>UDON Admin</h1>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="restaurant">Restaurante</label>
                    <select id="restaurant" required>
                        <option value="">Selecciona tu restaurante</option>
                        <option value="alisios">UDON CC ALISIOS</option>
                        <option value="meridiano">UDON CC MERIDIANO</option>
                        <option value="ruizalda">UDON RUIZ DE ALDA</option>
                        <option value="data">üóÇÔ∏è GESTI√ìN DE DATOS (Usuario especial)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" required>
                </div>
                
                <button type="submit" id="loginBtn">Iniciar Sesi√≥n</button>
            </form>
            
            <div class="credentials">
                <h4>Credenciales de prueba:</h4>
                <p><strong>ALISIOS:</strong> admin_alisios / alisios2025</p>
                <p><strong>MERIDIANO:</strong> admin_meridiano / meridiano2025</p>
                <p><strong>RUIZ DE ALDA:</strong> admin_ruizalda / ruizalda2025</p>
                <p><strong>GESTI√ìN DE DATOS:</strong> data / dataUDON2025</p>
            </div>
        </div>
    </div>

    <!-- Panel de Administraci√≥n -->
    <div id="admin-panel" class="hidden">
        <div class="admin-panel">
            <div class="header">
                <div class="header-left">
                    <img src="LOGO PNG UDON.png" alt="UDON Logo" class="logo-header">
                    <h1>Panel de Administraci√≥n - <span id="restaurant-name"></span></h1>
                </div>
                <div>
                    <button onclick="loadReservations()" style="margin-right: 10px;">üîÑ Actualizar</button>
                    <button onclick="showChangePasswordModal()" style="margin-right: 10px;">üîê Cambiar Contrase√±a</button>
                    <button onclick="logout()">üö™ Cerrar Sesi√≥n</button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-reservations">0</div>
                    <div class="stat-label">Reservas Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="confirmed-reservations">0</div>
                    <div class="stat-label">Confirmadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="available-tables">0</div>
                    <div class="stat-label">Mesas Disponibles</div>
                </div>
            </div>

            <!-- Gesti√≥n de Horarios -->
            <div class="schedule-section">
                <div class="schedule-header">
                    <h2 class="schedule-title">üïí Gesti√≥n de Horarios</h2>
                    <button class="btn-schedule btn-save" onclick="saveSchedule()">üíæ Guardar Horarios</button>
                </div>
                <div id="schedule-form" class="schedule-form">
                    <!-- Los horarios se cargar√°n din√°micamente -->
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #2a2a2a; border-radius: 6px; color: #aaa; text-align: center; font-size: 0.9rem;">
                    Configure los horarios de apertura y cierre para cada d√≠a de la semana
                </div>
            </div>

            <!-- Gesti√≥n de Mesas -->
            <div class="tables-section">
                <div class="tables-header">
                    <h2 class="tables-title">ü™ë Gesti√≥n de Mesas</h2>
                    <div class="tables-actions">
                        <button class="btn-tables btn-add" onclick="addTable()">‚ûï Agregar Mesa</button>
                        <button class="btn-tables btn-save" onclick="saveTables()">üíæ Guardar Cambios</button>
                    </div>
                </div>
                <div id="tables-container" class="tables-container">
                    <!-- Las mesas se cargar√°n din√°micamente -->
                </div>
            </div>

            <div id="reservations-container">
                <p style="text-align: center; padding: 2rem; color: #ccc;">Cargando reservas...</p>
            </div>
        </div>
    </div>

    <!-- Panel de Gesti√≥n de Datos -->
    <div id="data-panel" class="hidden">
        <div class="admin-panel">
            <div class="header">
                <div class="logo-container">
                    <img src="LOGO PNG UDON.png" alt="UDON Logo" class="logo">
                </div>
                <h1>Gesti√≥n de Datos de Clientes</h1>
                <button onclick="logout()" class="logout-btn">üö™ Cerrar Sesi√≥n</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-customers">0</div>
                    <div class="stat-label">Clientes √önicos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-data-reservations">0</div>
                    <div class="stat-label">Total Reservas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avg-reservations">0</div>
                    <div class="stat-label">Promedio por Cliente</div>
                </div>
            </div>

            <!-- Acciones de Datos -->
            <div class="data-actions">
                <button class="btn-data btn-export" onclick="exportToExcel()">üìä Exportar a Excel</button>
                <button class="btn-data btn-refresh" onclick="loadCustomerData()">üîÑ Actualizar Datos</button>
            </div>

            <!-- Tabla de Clientes -->
            <div id="customers-container">
                <p style="text-align: center; padding: 2rem; color: #ccc;">Cargando datos de clientes...</p>
            </div>

            <!-- Sistema de Tracking de Enlaces -->
            <div class="tracking-section">
                <div class="tracking-header">
                    <h2 class="section-title">üîó Sistema de Tracking de Enlaces</h2>
                    <button class="btn-tracking btn-create" onclick="showCreateTrackingModal()">‚ûï Crear Enlace</button>
                </div>
                
                <div class="tracking-stats">
                    <div class="stat-card-small">
                        <div class="stat-number-small" id="total-tracking-links">0</div>
                        <div class="stat-label-small">Enlaces Activos</div>
                    </div>
                    <div class="stat-card-small">
                        <div class="stat-number-small" id="total-tracking-clicks">0</div>
                        <div class="stat-label-small">Clicks Totales</div>
                    </div>
                    <div class="stat-card-small">
                        <div class="stat-number-small" id="avg-tracking-clicks">0</div>
                        <div class="stat-label-small">Promedio por Enlace</div>
                    </div>
                </div>

                <div id="tracking-links-container">
                    <p style="text-align: center; padding: 2rem; color: #ccc;">Cargando enlaces de tracking...</p>
                </div>
            </div>

            <!-- Estad√≠sticas por Restaurante -->
            <div class="restaurant-stats-section">
                <h2 class="section-title">üìç Estad√≠sticas por Restaurante</h2>
                <div id="restaurant-stats-container">
                    <!-- Se cargar√°n din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Crear Enlace de Tracking -->
    <div id="create-tracking-modal" class="hidden" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    ">
        <div style="
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            border: 1px solid #333;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        ">
            <h2 style="text-align: center; color: white; margin-bottom: 1.5rem;">üîó Crear Enlace de Tracking</h2>
            
            <form id="create-tracking-form" onsubmit="createTrackingLink(event)">
                <div class="form-group">
                    <label for="tracking-name" style="color: #ccc;">Nombre del Enlace</label>
                    <input type="text" id="tracking-name" required placeholder="Ej: Influencer Juan, Campa√±a Instagram, etc." style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #555;
                        border-radius: 8px;
                        background: #333;
                        color: white;
                        margin-bottom: 1rem;
                    ">
                    <small style="color: #888; font-size: 0.8rem;">Este nombre te ayudar√° a identificar el origen de las visitas</small>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #2a2a2a; border-radius: 8px; border: 1px solid #444;">
                    <h4 style="color: #667eea; margin-bottom: 0.5rem;">‚ÑπÔ∏è C√≥mo funciona:</h4>
                    <ul style="color: #ccc; font-size: 0.9rem; margin-left: 1rem;">
                        <li>Se generar√° un enlace √∫nico que redirige a tu web</li>
                        <li>Cada vez que alguien haga click, se contabilizar√°</li>
                        <li>Podr√°s ver estad√≠sticas detalladas de cada enlace</li>
                        <li>El enlace ser√° del tipo: <code style="background: #333; padding: 2px 4px; border-radius: 3px;">tudominio.com/track/abc123</code></li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="hideCreateTrackingModal()" style="
                        flex: 1;
                        padding: 12px;
                        background: #666;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                    ">Cancelar</button>
                    <button type="submit" style="
                        flex: 1;
                        padding: 12px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                    ">Crear Enlace</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cambio de Contrase√±a -->
    <div id="change-password-modal" class="hidden" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    ">
        <div style="
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #333;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        ">
            <h2 style="text-align: center; color: white; margin-bottom: 1.5rem;">üîê Cambiar Contrase√±a</h2>
            
            <form id="change-password-form" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label for="current-password" style="color: #ccc;">Contrase√±a Actual</label>
                    <input type="password" id="current-password" required style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #555;
                        border-radius: 8px;
                        background: #333;
                        color: white;
                        margin-bottom: 1rem;
                    ">
                </div>
                
                <div class="form-group">
                    <label for="new-password" style="color: #ccc;">Nueva Contrase√±a</label>
                    <input type="password" id="new-password" required minlength="8" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #555;
                        border-radius: 8px;
                        background: #333;
                        color: white;
                        margin-bottom: 1rem;
                    ">
                    <small style="color: #888; font-size: 0.8rem;">M√≠nimo 8 caracteres</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm-password" style="color: #ccc;">Confirmar Nueva Contrase√±a</label>
                    <input type="password" id="confirm-password" required minlength="8" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #555;
                        border-radius: 8px;
                        background: #333;
                        color: white;
                        margin-bottom: 1.5rem;
                    ">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="hideChangePasswordModal()" style="
                        flex: 1;
                        padding: 12px;
                        background: #666;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                    ">Cancelar</button>
                    <button type="submit" style="
                        flex: 1;
                        padding: 12px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                    ">Cambiar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('üöÄ UDON Admin iniciado');
        
        let authToken = null;
        let currentRestaurant = null;

        // Variable global para almacenar las mesas del restaurante
        let currentTables = [];

        // Funci√≥n auxiliar para obtener el nombre de una mesa por ID
        function getTableName(tableId) {
            const table = currentTables.find(t => t.id === tableId);
            return table ? table.name : `Mesa ${tableId}`;
        }

        // Funci√≥n para mostrar alertas
        function showAlert(message, type) {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }

        // Manejar login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('üîê Iniciando login');
            
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = 'Iniciando...';
            loginBtn.disabled = true;
            
            const restaurant = document.getElementById('restaurant').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const formData = {
                restaurant: restaurant === 'data' ? 'data' : restaurant,
                username: username,
                password: password
            };
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.token;
                    currentRestaurant = result.restaurant;
                    
                    console.log('‚úÖ Login exitoso');
                    
                    // Verificar si es usuario de datos
                    if (result.type === 'data_manager') {
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('data-panel').classList.remove('hidden');
                        loadCustomerData();
                        showAlert('¬°Bienvenido al panel de datos!', 'success');
                    } else {
                        // Login normal de restaurante
                        document.getElementById('restaurant-name').textContent = result.restaurantName;
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('admin-panel').classList.remove('hidden');
                        
                        loadReservations();
                        loadSchedule();
                        loadTables(); // Cargar configuraci√≥n de mesas
                        updateAvailableTables(); // Calcular mesas disponibles al cargar
                        showAlert('¬°Bienvenido!', 'success');
                    }
                } else {
                    showAlert(result.error || 'Error al iniciar sesi√≥n', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n', 'error');
            } finally {
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        });

        // Cargar reservas
        async function loadReservations() {
            if (!authToken) return;
            
            console.log('üì° Cargando reservas...');
            
            try {
                const response = await fetch('/api/admin/reservations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const reservations = await response.json();
                    console.log('‚úÖ Reservas cargadas:', reservations);
                    displayReservations(reservations);
                    updateStats(reservations);
                } else {
                    showAlert('Error al cargar reservas', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n', 'error');
            }
        }

        // Cargar horarios del restaurante
        async function loadSchedule() {
            if (!authToken) return;
            
            console.log('üïí Cargando horarios...');
            
            try {
                const response = await fetch('/api/admin/schedule', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Horarios cargados:', data.schedule);
                    displaySchedule(data.schedule);
                } else {
                    const error = await response.json();
                    console.error('Error del servidor:', error);
                    showAlert('Error al cargar horarios: ' + (error.error || 'Error desconocido'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n al cargar horarios', 'error');
            }
        }

        // Mostrar horarios en el formulario
        function displaySchedule(schedule) {
            const container = document.getElementById('schedule-form');
            if (!container) {
                console.error('Container schedule-form no encontrado');
                return;
            }
            
            const dayNames = {
                monday: 'Lunes',
                tuesday: 'Martes', 
                wednesday: 'Mi√©rcoles',
                thursday: 'Jueves',
                friday: 'Viernes',
                saturday: 'S√°bado',
                sunday: 'Domingo'
            };

            const daysOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            container.innerHTML = '';
            
            daysOrder.forEach(day => {
                const daySchedule = schedule[day] || { open: '12:00', close: '23:00', closed: false };
                addScheduleRow(day, dayNames[day], daySchedule);
            });
        }

        // Agregar fila de horario
        function addScheduleRow(dayKey, dayName, daySchedule) {
            const container = document.getElementById('schedule-form');
            const rowId = `schedule-row-${dayKey}`;
            
            const row = document.createElement('div');
            row.className = 'schedule-item';
            row.id = rowId;
            row.dataset.day = dayKey;
            
            row.innerHTML = `
                <div class="schedule-day-name">
                    <strong>${dayName}</strong>
                </div>
                <div class="schedule-controls">
                    <label class="schedule-checkbox">
                        <input type="checkbox" class="schedule-closed" ${daySchedule.closed ? 'checked' : ''} 
                               onchange="toggleDayClosed('${dayKey}')">
                        <span>Cerrado</span>
                    </label>
                    <label class="schedule-checkbox">
                        <input type="checkbox" class="schedule-24h" ${daySchedule.close === '24:00' ? 'checked' : ''} 
                               onchange="toggle24Hours('${dayKey}')" ${daySchedule.closed ? 'disabled' : ''}>
                        <span>24 horas</span>
                    </label>
                    <div class="schedule-times ${daySchedule.closed ? 'disabled' : ''}">
                        <label>Apertura:</label>
                        <input type="time" class="schedule-open" value="${daySchedule.open || '12:00'}" 
                               ${daySchedule.closed ? 'disabled' : ''}>
                        <label>Cierre:</label>
                        <input type="time" class="schedule-close" value="${daySchedule.close === '24:00' ? '23:59' : (daySchedule.close || '23:00')}" 
                               ${daySchedule.closed ? 'disabled' : ''}>
                    </div>
                </div>
            `;
            
            container.appendChild(row);
        }

        // Alternar d√≠a cerrado
        function toggleDayClosed(dayKey) {
            const row = document.getElementById(`schedule-row-${dayKey}`);
            const closedCheckbox = row.querySelector('.schedule-closed');
            const timesContainer = row.querySelector('.schedule-times');
            const timeInputs = row.querySelectorAll('.schedule-times input');
            
            if (closedCheckbox.checked) {
                timesContainer.classList.add('disabled');
                timeInputs.forEach(input => input.disabled = true);
            } else {
                timesContainer.classList.remove('disabled');
                timeInputs.forEach(input => input.disabled = false);
            }
        }

        // Alternar cierre a las 24:00
        function toggle24Hours(dayKey) {
            const row = document.getElementById(`schedule-row-${dayKey}`);
            const checkbox24h = row.querySelector('.schedule-24h');
            const closeInput = row.querySelector('.schedule-close');
            
            if (checkbox24h.checked) {
                closeInput.value = '23:59';
                closeInput.disabled = true;
            } else {
                closeInput.disabled = false;
                if (closeInput.value === '23:59') {
                    closeInput.value = '23:00';
                }
            }
        }

        // Guardar horarios
        async function saveSchedule() {
            if (!authToken) return;
            
            const scheduleItems = document.querySelectorAll('.schedule-item');
            const schedule = {};
            let hasErrors = false;
            
            // Recopilar datos del formulario
            scheduleItems.forEach(item => {
                const dayKey = item.dataset.day;
                const closed = item.querySelector('.schedule-closed').checked;
                const open = item.querySelector('.schedule-open').value;
                const closeInput = item.querySelector('.schedule-close');
                const is24h = item.querySelector('.schedule-24h').checked;
                
                let close = closeInput.value;
                if (is24h) {
                    close = '24:00';
                }
                
                if (!closed && (!open || !close)) {
                    showAlert(`Faltan horarios para ${item.querySelector('.schedule-day-name strong').textContent}`, 'error');
                    hasErrors = true;
                    return;
                }
                
                if (!closed && open >= close && close !== '24:00') {
                    showAlert(`La hora de cierre debe ser posterior a la de apertura para ${item.querySelector('.schedule-day-name strong').textContent}`, 'error');
                    hasErrors = true;
                    return;
                }
                
                schedule[dayKey] = {
                    open: open || '12:00',
                    close: close || '23:00',
                    closed: closed
                };
            });
            
            if (hasErrors) return;
            
            console.log('üíæ Guardando horarios:', schedule);
            
            try {
                const response = await fetch('/api/admin/schedule', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ schedule })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Horarios guardados:', result);
                    showAlert('Horarios actualizados correctamente', 'success');
                    
                    // Recargar horarios para reflejar cambios
                    setTimeout(() => loadSchedule(), 1000);
                } else {
                    const error = await response.json();
                    console.error('Error del servidor:', error);
                    showAlert(error.error || 'Error al guardar horarios', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n al guardar horarios', 'error');
            }
        }

        // Mostrar reservas
        function displayReservations(reservations) {
            const container = document.getElementById('reservations-container');
            
            if (reservations.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #ccc;">No hay reservas para este restaurante.</p>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Tel√©fono</th>
                            <th>Email</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Personas</th>
                            <th>Mesa</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reservations.map(r => `
                            <tr>
                                <td>#${r.id}</td>
                                <td><strong>${r.name}</strong></td>
                                <td>${r.phone}</td>
                                <td>${r.email}</td>
                                <td>${r.date}</td>
                                <td>${r.time}</td>
                                <td>${r.guests || r.people || 0}</td>
                                <td>${getTableName(r.tableId)}</td>
                                <td><span class="status-${r.status}">${r.status.toUpperCase()}</span></td>
                                <td>
                                    <select class="status-select" onchange="updateStatus(${r.id}, this.value)">
                                        <option value="confirmada" ${r.status === 'confirmada' ? 'selected' : ''}>Confirmada</option>
                                        <option value="completada" ${r.status === 'completada' ? 'selected' : ''}>Completada</option>
                                        <option value="cancelada" ${r.status === 'cancelada' ? 'selected' : ''}>Cancelada</option>
                                    </select>
                                    <button class="btn-small btn-danger" onclick="deleteReservation(${r.id})">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Actualizar estad√≠sticas usando el endpoint oficial
        async function updateStats(reservations) {
            try {
                if (!authToken) {
                    console.warn('‚ö†Ô∏è No hay token de autenticaci√≥n para updateStats');
                    return;
                }
                
                console.log('üìä Actualizando estad√≠sticas con token...');
                
                // Usar el endpoint de estad√≠sticas oficial
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const stats = await response.json();
                    console.log('üìä Estad√≠sticas recibidas del servidor:', stats);
                    
                    document.getElementById('total-reservations').textContent = stats.totalReservations || 0;
                    document.getElementById('confirmed-reservations').textContent = stats.statusBreakdown?.confirmed || 0;
                    document.getElementById('available-tables').textContent = stats.availableTables || 0;
                    
                    console.log('‚úÖ Estad√≠sticas actualizadas en DOM');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error al cargar estad√≠sticas:', response.status, errorText);
                    // Fallback a c√°lculo local
                    document.getElementById('total-reservations').textContent = reservations?.length || 0;
                    document.getElementById('confirmed-reservations').textContent = 
                        reservations?.filter(r => r.status === 'confirmed' || r.status === 'confirmada').length || 0;
                }
            } catch (error) {
                console.error('‚ùå Error en updateStats:', error);
                // Fallback a c√°lculo local
                document.getElementById('total-reservations').textContent = reservations?.length || 0;
                document.getElementById('confirmed-reservations').textContent = 
                    reservations?.filter(r => r.status === 'confirmed' || r.status === 'confirmada').length || 0;
            }
        }

        // Funci√≥n obsoleta - las estad√≠sticas se obtienen del endpoint oficial
        async function updateAvailableTables() {
            // Las estad√≠sticas ahora se obtienen desde /api/admin/stats
            console.log('üìä Usando estad√≠sticas del endpoint oficial');
        }

        // Actualizar estado de reserva
        async function updateStatus(id, newStatus) {
            if (!authToken) return;
            
            try {
                const response = await fetch(`/api/admin/reservations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    showAlert('Estado actualizado', 'success');
                    loadReservations();
                } else {
                    showAlert('Error al actualizar', 'error');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n', 'error');
            }
        }

        // Eliminar reserva
        async function deleteReservation(id) {
            if (!confirm('¬øEliminar esta reserva?')) return;
            if (!authToken) return;
            
            try {
                const response = await fetch(`/api/admin/reservations/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showAlert('Reserva eliminada', 'success');
                    loadReservations();
                } else {
                    showAlert('Error al eliminar', 'error');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n', 'error');
            }
        }

        // ===================================
        // FUNCIONES PARA CAMBIO DE CONTRASE√ëA
        // ===================================
        
        // Mostrar modal de cambio de contrase√±a
        function showChangePasswordModal() {
            document.getElementById('change-password-modal').classList.remove('hidden');
            document.getElementById('current-password').focus();
        }

        // Ocultar modal de cambio de contrase√±a
        function hideChangePasswordModal() {
            document.getElementById('change-password-modal').classList.add('hidden');
            document.getElementById('change-password-form').reset();
        }

        // Cambiar contrase√±a
        async function changePassword(event) {
            event.preventDefault();
            
            if (!authToken) {
                showAlert('No hay sesi√≥n activa', 'error');
                return;
            }

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // Validaciones del lado cliente
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('Todos los campos son obligatorios', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showAlert('La nueva contrase√±a debe tener al menos 8 caracteres', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('Las contrase√±as no coinciden', 'error');
                return;
            }

            if (currentPassword === newPassword) {
                showAlert('La nueva contrase√±a debe ser diferente a la actual', 'error');
                return;
            }

            try {
                // Deshabilitar bot√≥n para evitar doble env√≠o
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Cambiando...';

                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('‚úÖ Contrase√±a actualizada correctamente', 'success');
                    hideChangePasswordModal();
                    
                    // Log de √©xito para auditor√≠a
                    console.log('üîê Contrase√±a cambiada exitosamente');
                    
                } else {
                    showAlert(`‚ùå ${data.error || 'Error al cambiar contrase√±a'}`, 'error');
                }

            } catch (error) {
                console.error('Error al cambiar contrase√±a:', error);
                showAlert('‚ùå Error de conexi√≥n al cambiar contrase√±a', 'error');
            } finally {
                // Rehabilitar bot√≥n
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Cambiar';
            }
        }

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('change-password-modal');
                if (!modal.classList.contains('hidden')) {
                    hideChangePasswordModal();
                }
            }
        });

        // Cerrar sesi√≥n
        function logout() {
            authToken = null;
            currentRestaurant = null;
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('data-panel').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        }

        // ========================
        // GESTI√ìN DE MESAS
        // ========================

        // Cargar mesas del restaurante
        async function loadTables() {
            if (!authToken || !currentRestaurant) return;
            
            try {
                console.log('ü™ë Cargando mesas...');
                const response = await fetch(`/api/admin/tables`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const tables = await response.json();
                    console.log('‚úÖ Mesas cargadas:', tables);
                    displayTables(tables);
                } else {
                    showAlert('Error al cargar mesas', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n', 'error');
            }
        }

        // Mostrar mesas en la interfaz
        function displayTables(tables) {
            // Actualizar la variable global para usar en getTableName
            currentTables = tables;
            
            const container = document.getElementById('tables-container');
            
            if (tables.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #ccc;">No hay mesas configuradas.</p>';
                return;
            }
            
            container.innerHTML = tables.map(table => `
                <div class="table-item ${table.available ? 'available' : 'occupied'}" id="table-${table.id}">
                    <div class="table-info">
                        <div class="table-id">ID: ${table.id}</div>
                        <div class="table-name">
                            <label>Nombre:</label>
                            <input type="text" 
                                   value="${table.name || `Mesa ${table.id}`}" 
                                   maxlength="30"
                                   placeholder="Nombre de la mesa"
                                   onchange="updateTableName(${table.id}, this.value)">
                        </div>
                        <div class="table-capacity">
                            <label>Capacidad:</label>
                            <input type="number" 
                                   value="${table.capacity}" 
                                   min="1" 
                                   max="20"
                                   onchange="updateTableCapacity(${table.id}, this.value)">
                        </div>
                        <div class="table-status">
                            <div class="status-indicator ${table.available ? 'available' : 'occupied'}"></div>
                            <span>${table.available ? 'Disponible' : 'Ocupada'}</span>
                        </div>
                    </div>
                    <div class="table-actions">
                        <button class="btn-tables btn-remove-table" onclick="removeTable(${table.id})">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        // Agregar nueva mesa
        async function addTable() {
            if (!authToken) return;
            
            try {
                console.log('‚ûï Creando nueva mesa...');
                
                // Crear nueva mesa en el servidor usando POST
                const response = await fetch('/api/admin/tables', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: `Mesa Nueva`,
                        capacity: 4
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Mesa creada exitosamente:', result);
                    showAlert('Mesa agregada correctamente', 'success');
                    
                    // Recargar la lista de mesas para reflejar el cambio
                    await loadTables();
                    await updateAvailableTables();
                } else {
                    const error = await response.json();
                    console.error('‚ùå Error creando mesa:', error);
                    showAlert(error.error || 'Error al agregar mesa', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showAlert('Error de conexi√≥n al agregar mesa', 'error');
            }
        }

        // Actualizar nombre de mesa
        function updateTableName(tableId, newName) {
            const name = newName.trim();
            if (name.length === 0) {
                showAlert('El nombre de la mesa no puede estar vac√≠o', 'error');
                return;
            }
            if (name.length > 30) {
                showAlert('El nombre de la mesa no puede tener m√°s de 30 caracteres', 'error');
                return;
            }
            
            // Actualizar en la variable global
            const table = currentTables.find(t => t.id === tableId);
            if (table) {
                table.name = name;
            }
            
            console.log(`üè∑Ô∏è Mesa ${tableId} nombre actualizado a "${name}"`);
        }

        // Actualizar capacidad de mesa
        function updateTableCapacity(tableId, newCapacity) {
            const capacity = parseInt(newCapacity);
            if (capacity < 1 || capacity > 20) {
                showAlert('La capacidad debe estar entre 1 y 20 personas', 'error');
                return;
            }
            console.log(`üîÑ Mesa ${tableId} capacidad actualizada a ${capacity}`);
        }

        // Eliminar mesa
        async function removeTable(tableId) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar la mesa ${tableId}?`)) {
                return;
            }
            
            if (!authToken) return;
            
            try {
                console.log(`üóëÔ∏è Eliminando mesa ${tableId}...`);
                
                const response = await fetch(`/api/admin/tables/${tableId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Mesa eliminada exitosamente:', result);
                    showAlert('Mesa eliminada correctamente', 'success');
                    
                    // Recargar la lista de mesas para reflejar el cambio
                    await loadTables();
                    await updateAvailableTables();
                } else {
                    const error = await response.json();
                    console.error('‚ùå Error eliminando mesa:', error);
                    showAlert(error.error || 'Error al eliminar mesa', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showAlert('Error de conexi√≥n al eliminar mesa', 'error');
            }
        }

        // Guardar cambios en las mesas
        async function saveTables() {
            if (!authToken) return;
            
            const tableElements = document.querySelectorAll('.table-item');
            const tables = Array.from(tableElements).map(element => {
                const idMatch = element.id.match(/table-(\d+)/);
                const nameInput = element.querySelector('input[type="text"]');
                const capacityInput = element.querySelector('input[type="number"]');
                const isAvailable = element.classList.contains('available');
                
                return {
                    id: parseInt(idMatch[1]),
                    name: nameInput.value.trim(),
                    capacity: parseInt(capacityInput.value),
                    available: isAvailable
                };
            });
            
            console.log('üíæ Guardando mesas:', tables);
            
            try {
                const response = await fetch('/api/admin/tables', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tables })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Mesas guardadas:', result);
                    showAlert('Configuraci√≥n de mesas actualizada correctamente', 'success');
                    // Recargar mesas para reflejar cambios del servidor
                    await loadTables();
                    // Actualizar contador de mesas disponibles
                    await updateAvailableTables();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Error al guardar mesas', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n', 'error');
            }
        }

        // ========================
        // GESTI√ìN DE DATOS DE CLIENTES
        // ========================

        // Cargar datos de clientes
        async function loadCustomerData() {
            if (!authToken) return;
            
            console.log('üìÇ Cargando datos de clientes...');
            
            try {
                const response = await fetch('/api/data/customers', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Datos de clientes cargados:', data);
                    displayCustomerData(data.customers);
                    updateCustomerStats(data);
                    loadRestaurantStats();
                    loadTrackingLinks(); // Cargar enlaces de tracking
                } else {
                    showAlert('Error al cargar datos de clientes', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n', 'error');
            }
        }

        // Mostrar datos de clientes en la tabla
        function displayCustomerData(customers) {
            const container = document.getElementById('customers-container');
            
            if (customers.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #ccc;">No hay datos de clientes.</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="customers-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Tel√©fono</th>
                            <th>Total Reservas</th>
                            <th>Primera Reserva</th>
                            <th>√öltima Reserva</th>
                            <th>Restaurante Principal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${customers.map(c => `
                            <tr>
                                <td><strong>${c.name}</strong></td>
                                <td>${c.email}</td>
                                <td>${c.phone}</td>
                                <td>${c.totalReservations}</td>
                                <td>${c.firstReservation}</td>
                                <td>${c.lastReservation}</td>
                                <td>${c.restaurant}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Actualizar estad√≠sticas de clientes
        function updateCustomerStats(data) {
            console.log('üìä Actualizando estad√≠sticas de clientes:', data);
            console.log('Total customers:', data.totalCustomers);
            console.log('Total reservations:', data.totalReservations);
            
            document.getElementById('total-customers').textContent = data.totalCustomers || 0;
            document.getElementById('total-data-reservations').textContent = data.totalReservations || 0;
            document.getElementById('avg-reservations').textContent = 
                data.totalCustomers > 0 ? (data.totalReservations / data.totalCustomers).toFixed(1) : '0';
        }

        // Cargar estad√≠sticas por restaurante
        async function loadRestaurantStats() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/data/stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    displayRestaurantStats(stats);
                } else {
                    console.error('Error al cargar estad√≠sticas de restaurantes');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Mostrar estad√≠sticas por restaurante
        function displayRestaurantStats(stats) {
            const container = document.getElementById('restaurant-stats-container');
            
            container.innerHTML = Object.entries(stats.restaurantStats).map(([restaurant, data]) => `
                <div class="restaurant-stat-card">
                    <h3>${restaurant.toUpperCase()}</h3>
                    <div class="restaurant-stat-grid">
                        <div class="restaurant-stat-item">
                            <span class="stat-number">${data.totalCustomers}</span>
                            <span class="stat-label">Clientes</span>
                        </div>
                        <div class="restaurant-stat-item">
                            <span class="stat-number">${data.totalReservations}</span>
                            <span class="stat-label">Reservas</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ===================================
        // FUNCIONES PARA TRACKING DE ENLACES
        // ===================================

        // Cargar enlaces de tracking
        async function loadTrackingLinks() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/admin/tracking-links', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayTrackingLinks(data);
                } else if (response.status === 403) {
                    // No mostrar error si no tiene permisos, simplemente no cargar
                    document.getElementById('tracking-links-container').innerHTML = `
                        <p style="text-align: center; padding: 2rem; color: #888;">
                            Los enlaces de tracking solo est√°n disponibles para el gestor de datos.
                        </p>
                    `;
                } else {
                    console.error('Error al cargar enlaces de tracking');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Mostrar enlaces de tracking
        function displayTrackingLinks(data) {
            const { links, summary } = data;
            
            // Actualizar estad√≠sticas
            document.getElementById('total-tracking-links').textContent = summary.totalLinks;
            document.getElementById('total-tracking-clicks').textContent = summary.totalClicks;
            document.getElementById('avg-tracking-clicks').textContent = summary.averageClicks;
            
            // Mostrar tabla de enlaces
            const container = document.getElementById('tracking-links-container');
            
            if (links.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; padding: 2rem; color: #ccc;">
                        No hay enlaces de tracking creados. ¬°Crea tu primer enlace!
                    </p>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="tracking-links-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Enlace</th>
                            <th>Clicks</th>
                            <th>√öltimo Click</th>
                            <th>Creado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${links.map(link => `
                            <tr>
                                <td><strong>${link.name}</strong></td>
                                <td>
                                    <div class="tracking-link-url" onclick="copyToClipboard('${link.fullUrl}')" title="Click para copiar">
                                        ${link.fullUrl}
                                    </div>
                                </td>
                                <td><span class="tracking-clicks">${link.clicks}</span></td>
                                <td class="tracking-date">
                                    ${link.lastClick ? formatDate(link.lastClick) : 'Nunca'}
                                </td>
                                <td class="tracking-date">${formatDate(link.createdAt)}</td>
                                <td>
                                    <div class="tracking-actions">
                                        <button class="btn-tracking btn-delete" onclick="deleteTrackingLink('${link.id}', '${link.name}')" title="Eliminar enlace">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Mostrar modal de crear enlace
        function showCreateTrackingModal() {
            document.getElementById('create-tracking-modal').classList.remove('hidden');
            document.getElementById('tracking-name').focus();
        }

        // Ocultar modal de crear enlace
        function hideCreateTrackingModal() {
            document.getElementById('create-tracking-modal').classList.add('hidden');
            document.getElementById('create-tracking-form').reset();
        }

        // Crear enlace de tracking
        async function createTrackingLink(event) {
            event.preventDefault();
            
            if (!authToken) {
                showAlert('No hay sesi√≥n activa', 'error');
                return;
            }

            const name = document.getElementById('tracking-name').value.trim();
            
            if (!name) {
                showAlert('El nombre del enlace es obligatorio', 'error');
                return;
            }

            try {
                // Deshabilitar bot√≥n para evitar doble env√≠o
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creando...';

                const response = await fetch('/api/admin/tracking-links', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`‚úÖ Enlace "${name}" creado correctamente`, 'success');
                    hideCreateTrackingModal();
                    loadTrackingLinks(); // Recargar la lista
                    
                    // Mostrar el enlace creado para copiar
                    setTimeout(() => {
                        showAlert(`üîó Enlace copiado: ${data.link.fullUrl}`, 'success');
                        copyToClipboard(data.link.fullUrl);
                    }, 500);
                    
                } else {
                    showAlert(`‚ùå ${data.error || 'Error al crear enlace'}`, 'error');
                }

            } catch (error) {
                console.error('Error al crear enlace:', error);
                showAlert('‚ùå Error de conexi√≥n al crear enlace', 'error');
            } finally {
                // Rehabilitar bot√≥n
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Crear Enlace';
            }
        }

        // Eliminar enlace de tracking
        async function deleteTrackingLink(linkId, linkName) {
            if (!confirm(`¬øEliminar el enlace "${linkName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            if (!authToken) {
                showAlert('No hay sesi√≥n activa', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/admin/tracking-links/${linkId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`‚úÖ Enlace "${linkName}" eliminado correctamente`, 'success');
                    loadTrackingLinks(); // Recargar la lista
                } else {
                    showAlert(`‚ùå ${data.error || 'Error al eliminar enlace'}`, 'error');
                }

            } catch (error) {
                console.error('Error al eliminar enlace:', error);
                showAlert('‚ùå Error de conexi√≥n al eliminar enlace', 'error');
            }
        }

        // Copiar enlace al portapapeles
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showAlert('üìã Enlace copiado al portapapeles', 'success');
            } catch (error) {
                console.error('Error al copiar:', error);
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('üìã Enlace copiado al portapapeles', 'success');
                } catch (fallbackError) {
                    showAlert('‚ùå Error al copiar enlace', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // Formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const trackingModal = document.getElementById('create-tracking-modal');
                const passwordModal = document.getElementById('change-password-modal');
                
                if (!trackingModal.classList.contains('hidden')) {
                    hideCreateTrackingModal();
                } else if (!passwordModal.classList.contains('hidden')) {
                    hideChangePasswordModal();
                }
            }
        });

        // Exportar datos a Excel
        async function exportToExcel() {
            if (!authToken) return;
            
            console.log('üì§ Iniciando exportaci√≥n a Excel...');
            showAlert('Generando archivo Excel...', 'success');
            
            try {
                const response = await fetch('/api/data/export/excel', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `udon_clientes_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('‚úÖ Archivo descargado exitosamente', 'success');
                } else {
                    showAlert('Error al exportar datos', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n al exportar', 'error');
            }
        }

        // Mostrar u ocultar panel de gesti√≥n de datos
        function toggleDataPanel() {
            const isHidden = document.getElementById('data-panel').classList.contains('hidden');
            document.getElementById('data-panel').classList.toggle('hidden', !isHidden);
            document.getElementById('admin-panel').classList.toggle('hidden', isHidden);
            
            if (!isHidden) {
                loadCustomerData();
            }
        }

        // Cambiar entre panel de administraci√≥n y panel de gesti√≥n de datos
        document.getElementById('admin-panel').addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-data-panel')) {
                e.preventDefault();
                toggleDataPanel();
            }
        });

        console.log('‚úÖ UDON Admin cargado completamente');
    </script>

    <!-- Footer Legal para Admin -->
    <footer style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(26, 26, 26, 0.95);
        padding: 0.5rem;
        text-align: center;
        border-top: 1px solid #333;
        backdrop-filter: blur(10px);
    ">
        <div style="font-size: 0.8rem; color: #888;">
            <a href="/aviso-legal.html" target="_blank" style="color: #d32f2f; text-decoration: none; margin: 0 0.5rem;">Aviso Legal</a>
            <a href="/privacidad.html" target="_blank" style="color: #d32f2f; text-decoration: none; margin: 0 0.5rem;">Privacidad</a>
            <a href="/cookies.html" target="_blank" style="color: #d32f2f; text-decoration: none; margin: 0 0.5rem;">Cookies</a>
            <span style="margin: 0 1rem;">|</span>
            <span>RGPD Compliant</span>
        </div>
    </footer>
</body>
</html>